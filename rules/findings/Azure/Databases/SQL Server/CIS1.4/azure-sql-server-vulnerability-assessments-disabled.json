{
  "args": [
    
  ],
  "provider": "Azure",
  "serviceType": "SQL Server",
  "serviceName": "Databases",
  "displayName": "Ensure that Vulnerability Assessment (VA) is enabled on a SQL server by setting a Storage Account",
  "description": "Consider to enable Vulnerability Assessment (VA) service scans for critical SQL servers and corresponding SQL databases.",
  "rationale": "Enabling Microsoft Defender for Cloud for SQL server does not enables Vulnerability Assessment capability for individual SQL databases unless storage account is set to store the scanning data and reports.  \r\n\t\t\t\t   The Vulnerability Assessment service scans databases for known security vulnerabilities and highlight deviations from best practices, such as misconfigurations, excessivepermissions, and unprotected sensitive data. Results of the scan include actionable steps to resolve each issue and provide customized remediation scripts where applicable. Additionally an assessment report can be customized by setting an acceptable baseline for permission configurations, feature configurations, and database settings.",
  "impact": "Enabling the **Microsoft Defender for Cloud** for SQL features will incur additional costs for each SQL server.",
  "remediation": {
    "text": "###### From Azure Console\r\n\t\t\t\t\t1. Go to `SQL servers`.\r\n\t\t\t\t\t2. Select a server instance\r\n\t\t\t\t\t3. Click on `Microsoft Defender for Cloud`\r\n\t\t\t\t\t4. Select `Enable Microsoft Defender for Cloud for SQL`\r\n\t\t\t\t\t5. In Section `Vulnerability Assessment Settings`, Click `Storage Account`\r\n\t\t\t\t\t6. Choose Storage Account (Existing or Create New). Click `Ok`\r\n\t\t\t\t\t7. Click `Save`",
    "code": {
      "powerShell": null,
      "iac": null,
      "terraform": null,
      "other": null
    }
  },
  "recommendation": null,
  "references": [
    "https://docs.microsoft.com/en-us/azure/sql-database/sql-vulnerability-assessment",
    "https://docs.microsoft.com/en-us/rest/api/sql/servervulnerabilityassessments/listbyserver",
    "https://docs.microsoft.com/en-in/powershell/module/Az.Sql/Update-AzSqlServerVulnerabilityAssessmentSetting?view=azps-2.6.0",
    "https://docs.microsoft.com/en-in/powershell/module/Az.Sql/Get-AzSqlServerVulnerabilityAssessmentSetting?view=azps-2.6.0",
    "https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-posture-vulnerability-management#pv-6-perform-software-vulnerability-assessment"
  ],
  "compliance": [
    {
      "name": "CIS Microsoft Azure Foundations",
      "version": "1.4.0",
      "reference": "4.2.2"
    }
  ],
  "level": "medium",
  "tags": [
    
  ],
  "rule": {
    "path": "az_sql_servers",
    "subPath": null,
    "selectCondition": {
      
    },
    "query": [
      {
        "filter": [
          {
            "conditions": [
              [
                "vaConfig.properties.storageContainerPath",
                "ne",
                "null"
              ]
            ]
          }
        ]
      }
    ],
    "shouldExist": "true",
    "returnObject": {
      "Microsoft Defender for Cloud": "Vulnerability Assessment",
      "Status": "Not configured"
    },
    "removeIfNotExists": null
  },
  "output": {
    "html": {
      "data": {
        "properties": {
          "name": "Server Name",
          "location": "Location",
          "resourceGroupName": "Resource group name",
          "fqdn": "FQDN",
          "vaConfig.properties.recurringScans.isEnabled": "VA Enabled"
        },
        "expandObject": null
      },
      "table": "asList",
      "decorate": [
        
      ],
      "emphasis": [
        "VA Enabled"
      ],
      "actions": {
        "objectData": {
          "expand": null,
          "limit": null
        },
        "showGoToButton": null,
        "showModalButton": null
      }
    },
    "text": {
      "data": {
        "properties": {
          
        },
        "expandObject": null
      },
      "status": {
        "keyName": [
          
        ],
        "message": "",
        "defaultMessage": null
      },
      "properties": {
        "resourceName": null,
        "resourceId": null,
        "resourceType": null
      },
      "onlyStatus": false
    }
  },
  "idSuffix": "sql_server_va_disabled",
  "notes": [
    
  ],
  "categories": [
    
  ]
}
